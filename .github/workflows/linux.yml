name: Nightly builds on linux
on:
  push:
    paths:
      - '.github/workflows/linux.yml'
      - 'scripts/**'
  pull_request:
    paths:
      - '.github/workflows/linux.yml'
      - 'scripts/**'
  schedule:
    - cron: "0 2 * * *" # Every night at 2 AM UTC (9 PM EST; 10 PM EDT)
  workflow_dispatch:
jobs:
  libtiledb:
    runs-on: ubuntu-latest
    steps:
      - name: Clone TileDB
        uses: actions/checkout@v3
        with:
          repository: TileDB-Inc/TileDB
          ref: dev
          path: TileDB
      - name: Download release tarball
        run: wget https://github.com/TileDB-Inc/TileDB/releases/download/2.17.1/tiledb-linux-x86_64-2.17.1-7c8c73b.tar.gz
      - name: Unpack release tarball
        run: |
          mkdir install
          tar xzf tiledb-linux-x86_64-*.tar.gz -C install
          ls -R install/
      - name: Upload tarball as artifact
        uses: actions/upload-artifact@v3
        with:
          name: nightly-libtiledb
          path: |
            install/include/
            install/lib*/
          retention-days: 14
  tiledb-py:
    runs-on: ubuntu-latest
    needs: libtiledb
    env:
      LD_LIBRARY_PATH: ${{ github.workspace }}/install/lib
    steps:
      - name: Clone TileDB-Py
        uses: actions/checkout@v3
        with:
          repository: TileDB-Inc/TileDB-Py
          ref: dev
          path: TileDB-Py
      - name: Download nightly-libtiledb
        uses: actions/download-artifact@v3
        with:
          name: nightly-libtiledb
          path: install
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: python -m pip install --upgrade -r TileDB-Py/misc/requirements_ci.txt
      - name: Build TileDB-Py
        run: |
          echo $LD_LIBRARY_PATH
          cd TileDB-Py
          python setup.py install --tiledb="$GITHUB_WORKSPACE/install/"
      - name: Test TileDB-Py
        run: |
          python -c "import tiledb; print(tiledb.libtiledb.version())"
          #pytest -vv
      - name: Create a wheel
        run: |
          cd TileDB-Py
          python setup.py bdist_wheel --tiledb="$GITHUB_WORKSPACE/install/"
  tiledb-r:
    runs-on: ubuntu-latest
    needs: libtiledb
    env:
      _R_CHECK_FORCE_SUGGESTS_: "FALSE"
    steps:
      - name: Clone TileDB-R
        uses: actions/checkout@v3
        with:
          repository: TileDB-Inc/TileDB-R
          ref: master
      - name: Download nightly-libtiledb
        uses: actions/download-artifact@v3
        with:
          name: nightly-libtiledb
          path: install
      - name: Bootstrap
        run: ./.github/r-ci.sh bootstrap

      - name: Dependencies
        run: ./.github/r-ci.sh install_all

      - name: Test
        run: ./.github/r-ci.sh run_tests

      - name: Show install log
        run: cat $HOME/work/TileDB-R/TileDB-R/tiledb.Rcheck/00install.out
        if: failure()

      - name: Show test log
        run: cat $HOME/work/TileDB-R/TileDB-R/tiledb.Rcheck/00check.log
        if: failure()
  tiledb-vcf:
    runs-on: ubuntu-latest
    needs: [libtiledb, tiledb-py]
    steps:
      - name: Clone TileDB-VCF
        uses: actions/checkout@v3
        with:
          repository: TileDB-Inc/TileDB-VCF
          ref: main
          path: TileDB-VCF
  tiledb-soma:
    runs-on: ubuntu-latest
    needs: [libtiledb, tiledb-py, tiledb-r]
    steps:
      - name: Clone TileDB-SOMA
        uses: actions/checkout@v3
        with:
          repository: single-cell-data/TileDB-SOMA
          ref: main
          path: TileDB-SOMA
  tiledb-mariadb:
    runs-on: ubuntu-latest
    needs: [libtiledb]
    steps:
      - name: Clone TileDB-MariaDB
        uses: actions/checkout@v3
        with:
          repository: TileDB-Inc/TileDB-MariaDB
          ref: master
          path: TileDB-MariaDB
  tiledb-go:
    runs-on: ubuntu-latest
    needs: [libtiledb]
    steps:
      - name: Clone TileDB-Go
        uses: actions/checkout@v3
        with:
          repository: TileDB-Inc/TileDB-Go
          ref: master
          path: TileDB-Go
